<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.travel.bean.Order">
	<insert id="addOrder" parameterType="Order" useGeneratedKeys="true"
		keyProperty="id">
		insert into university_travel.order(
		category,
		user_id,
		route_id,
		coupon_id,
		description,
		status,
		state_msg,
		discount,
		price,
		order_from,
		create_time,
		update_time,
		name)
		values(
		#{category},#{userId},#{routeId},#{couponId},#{description},#{status},#{stateMsg},#{discount},#{price},#{orderFrom},
		sysdate(),sysdate(),#{name})
	</insert>

	<select id="getOrderById" parameterType="int" resultMap="OrderResultMap">
		select *
		from university_travel.order o where o.id = #{id}
	</select>
	<select id="getOrdersByUserId" parameterType="int" resultMap="OrderResultMap">
		select * from university_travel.order o where o.user_id = #{userId} order by
		o.update_time desc
	</select>
	<select id="getOrdersByUserIdAndStatus" parameterType="map"
		resultMap="OrderResultMap">
		select * from university_travel.order o where o.user_id = #{userId} and
		o.status = #{status} order by o.update_time desc
	</select>
	<update id="updateOrderStatus" parameterType="map">
		update university_travel.order o set o.status = #{status} and update_time = sysdate() where o.id = #{id}
	</update>
	
	<update id="updateOrder" parameterType="Order">
		update university_travel.order o 
		<set>
			update_time = sysdate()
			<if test="category!=null">and o.category = #{category}</if>
			<if test="description!=null">and o.description=#{description}</if>
			<if test="discount!=null">and o.discount =#{discount}</if>
			<if test="price!=null">and o.price = #{price}</if>
			<if test="stateMsg!=null">and o.state_msg =#{stateMsg}</if>
			<if test="name!=null">and o.name=#{name}</if>
			<if test="status!=null">and o.status = #{status}</if>
		</set>where o.id = #{id}
	</update>

	<insert id="addOrderItem" parameterType="OrderItem"
		useGeneratedKeys="true" keyProperty="id">
		insert into order_item(
		day,
		adult,
		child,
		insurance_amount,
		insurance_price,
		insurance_desc,
		booker_name,
		booker_phone,
		room_amount,
		order_id,
		hotel_price,
		insurance_price_per,
		basic_price,
		departure_date,
		end_date,
		hotel_info)
		values(
		#{day},
		#{adult},
		#{child},
		#{insuranceAmount},
		#{insurancePrice},
		#{insuranceDesc},
		#{bookerName},
		#{bookerPhone},
		#{roomAmount},
		#{orderId},
		#{hotelPrice},
		#{insurancePricePer},
		#{basicPrice},#{departureDate},#{endDate},#{hotelInfo}
		)

	</insert>
	<select id="getOrderItemByOrderId" parameterType="int"
		resultMap="OrderItemResultMap">
		select * from order_item oi where oi.order_id = #{orderId}
	</select>
	
	<update id="updateOrderItem" parameterType="OrderItem">
		update university_travel.order_item o 
		<set>
			update_time = sysdate()
			<if test="day!=null">and o.day = #{day}</if>
			<if test="adult!=null">and o.adult=#{adult}</if>
			<if test="child!=null">and o.child =#{child}</if>
			<if test="insuranceAmount!=null">and o.insurance_amount = #{insuranceAmount}</if>
			<if test="bookerName!=null">and o.booker_name =#{bookerName}</if>
			<if test="bookerPhone!=null">and o.booker_phone=#{bookerPhone}</if>
			<if test="hotelPrice!=null">and o.hotel_price = #{hotelPrice}</if>
			<if test="basicPrice!=null">and o.basic_price =#{basicPrice}</if>
			<if test="insurancePrice!=null">and o.insurance_price=#{insurancePrice}</if>
			<if test="departureDate!=null">and o.departureDate = #{departureDate}</if>
			<if test="endDate!=null">and o.endDate = #{endDate}</if>
			<if test="roomAmount!=null">and o.room_amount = #{roomAmount}</if>
			<if test="hotelInfo!=null">and o.hotel_info = #{hotelInfo}</if>
		</set>where o.order_id = #{orderId}
	</update>

	<insert id="addTourist" parameterType="Tourist"
		useGeneratedKeys="true" keyProperty="id">
		insert into tourist (
		name,
		order_id,
		type,
		license_type,
		license_number,
		insurance,
		create_time,
		update_time)
		values
		(#{name},#{orderId},#{type},#{licenseType},#{licenseNumber},#{insurance},sysdate(),sysdate())
	</insert>
	<select id="getTouristsByOrderId" parameterType="int"
		resultMap="TouristResultMap">
		select * from tourist t where t.order_id
		= #{orderId}
	</select>
	<resultMap id="OrderResultMap" type="Order">
		<id property="id" column="id" />
		<result property="category" column="category" />
		<result property="userId" column="user_id" />
		<result property="routeId" column="route_id" />
		<result property="couponId" column="coupon_id" />
		<result property="description" column="description" />
		<result property="status" column="status" />
		<result property="stateMsg" column="state_msg" />
		<result property="discount" column="discount" />
		<result property="price" column="price" />
		<result property="createTime" column="create_time" />
		<result property="updateTime" column="update_time" />
		<result property="orderFrom" column="order_from" />
		<result property="name" column="name" />
		<association property="orderItem" javaType="OrderItem"
			column="id" select="com.travel.bean.Order.getOrderItemByOrderId" />
		<collection property="tourists" ofType="Tourist" javaType="ArrayList"
			column="id" select="com.travel.bean.Order.getTouristsByOrderId" />
	</resultMap>
	<resultMap id="OrderItemResultMap" type="OrderItem">
		<id property="id" column="id" />
		<result property="day" column="day" />
		<result property="adult" column="adult" />
		<result property="child" column="child" />
		<result property="insuranceAmount" column="insurance_amount" />
		<result property="insurancePrice" column="insurance_price" />
		<result property="insuranceDesc" column="insurance_desc" />
		<result property="bookerName" column="booker_name" />
		<result property="bookerPhone" column="booker_phone" />
		<result property="roomAmount" column="room_amount" />
		<result property="orderId" column="order_id" />
		<result property="hotelPrice" column="hotel_price"/>
		<result property="insurancePricePer" column="insurance_price_per"/>
		<result property="basicPrice" column="basic_price"/>
		<result property="departureDate" column="departure_date"/>
		<result property="endDate" column="end_date"/>
		<result property="hotelInfo" column="hotel_info"/>
	</resultMap>
	<resultMap id="TouristResultMap" type="Tourist">
		<id property="id" column="id" />
		<result property="name" column="name" />
		<result property="orderId" column="order_id" />
		<result property="type" column="type"/>
		<result property="licenseType" column="license_type" />
		<result property="licenseNumber" column="license_number" />
		<result property="insurance" column="insurance" />
		<result property="createTime" column="create_time" />
		<result property="updateTime" column="update_time" />
	</resultMap>
</mapper>
